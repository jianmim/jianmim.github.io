import{b as e,d as s,a3 as a,r as o,w as l,aR as t,Q as r,R as i,a8 as n,a4 as u,aS as d,s as c,c as p,T as m,aA as f,y as g,H as v,a as y,V as h,o as b,e as T,f as U,g as k,i as F,j as w,u as x,F as C,a1 as I,h as _,K as E,a2 as P,n as S,k as B,C as j,p as A,_ as z}from"./index-80b03063.js";import{a as R,b as M,f as H}from"./index.b621671f.js";import{U as N,C as O}from"./event.5568c9d8.js";import{b as L}from"./index.f7e3486a.js";const $=["jpg","jpeg","png","gif","webp","ico"],D=e({modelValue:{type:s(Array),default:()=>[]},disabled:Boolean,action:String,name:{type:String,default:"file"},header:{type:Object,default:()=>({})},formData:{type:Object,default:()=>({})},limit:{type:Number,default:9},autoUpload:{type:Boolean,default:!0},showRemove:{type:Boolean,default:!0},showErrorTips:{type:Boolean,default:!0},showUploadProgress:{type:Boolean,default:!0},sizeType:{type:s(Array),default:()=>["original","compressed"]},sourceType:{type:s(Array),default:()=>["album","camera"]},multiple:{type:Boolean,default:!0},maxSize:{type:Number,default:10485760},extensions:{type:s(Array),default:()=>$},autoRemoveFaildFile:{type:Boolean,default:!1},customUploadHandler:{type:s(Function)},customUploadCallback:{type:s(Function)},beforeUpload:{type:s(Function)},beforeRemove:{type:s(Function)},validateEvent:{type:Boolean,default:!0}}),V=e=>{if("string"==typeof e)try{const s=JSON.parse(e);return!("object"!=typeof s||!s)}catch(s){return!1}return!1};const J=e=>{const{emit:s}=g(),{chooseImage:y,uploadProcess:h,checkFileSizeAndExtension:b,showErrorTips:T}=function(e){const s=o(!1);return l((()=>s.value),(s=>{e.showErrorTips&&(s?r({title:"上传中"}):i())})),{chooseImage:s=>new Promise(((o,l)=>{t({count:s,sizeType:e.sizeType,sourceType:e.sourceType,success:e=>{o(a(e.tempFiles)?e.tempFiles:[e.tempFiles])},fail:e=>{l(e)}})})),uploadProcess:a=>{const{customUploadHandler:o,customUploadCallback:l}=e;return s.value?Promise.reject("有文件正在上传"):new Promise(((t,r)=>{if(o){const e=o(a.file);if(![n(e),u(e)].includes(!0))return console.error("[TnImageUpload]自定义上传处理函数必须返回Promise和String"),void r("自定义上传处理函数必须返回Promise和String");s.value=!0,a.status="uploading",n(e)?e.then((e=>{e?(a.url=e,t(!0)):t(!1)})).catch((e=>{console.error("[TnImageUpload]上传文件发生错误",e),r((null==e?void 0:e.errMsg)||"上传文件发生错误")})).finally((()=>{s.value=!1})):(e?(a.url=e,t(!0)):t(!1),s.value=!1)}else{s.value=!0,a.status="uploading";const o=d({url:e.action,filePath:a.url,name:e.name,formData:e.formData,header:e.header,success:e=>{if(l){const s=l(e);if(![n(s),u(s)].includes(!0))return console.error("[TnImageUpload]自定义上传回调函数必须返回Promise和String"),void r("自定义上传回调函数必须返回Promise和String");n(s)?s.then((e=>{e?(a.url=e,t(!0)):t(!1)})).catch((e=>{console.error("[TnImageUpload]上传文件发生错误",e),r((null==e?void 0:e.errMsg)||"上传文件发生错误")})):s?(a.url=s,t(!0)):t(!1)}else{const{statusCode:s,data:o}=e;if(![200,201,204].includes(s))return console.error("[TnImageUpload]上传文件发生错误",e),void r((null==e?void 0:e.errMsg)||"上传文件发生错误");{const s=V(o)?JSON.parse(o):o;200===s.code&&0===s.data.errCode?(a.url=s.data.url,t(!0)):(console.error("[TnImageUpload]上传文件发生错误",e),r(R(null==s?void 0:s.message,(null==s?void 0:s.msg)||"上传文件发生错误")))}}},fail:e=>{console.error("[TnImageUpload]上传文件发生错误",e),r((null==e?void 0:e.errMsg)||"上传文件发生错误")},complete:()=>{s.value=!1,t(!0)}});a.uploadTask=o,o.onProgressUpdate((e=>{e.progress>0&&(a.progress=e.progress)}))}}))},checkFileSizeAndExtension:s=>{const{extensions:a,maxSize:o}=e,l=/.+\./;return s.filter((e=>{let s="";return s=e.name.replace(l,"").toLowerCase(),!a.some((e=>e.toLowerCase()===s))||e.size>o}))},showErrorTips:s=>{e.showErrorTips&&c({icon:"none",title:s})}}}(e),{formItem:U}=L(),k=o([]);let F=!1;l((()=>e.modelValue),(e=>{F?F=!1:k.value=e.map((e=>({url:e,status:"done",progress:100})))}),{immediate:!0});const w=p((()=>k.value.length>=e.limit)),x=p((()=>e.multiple?e.limit-k.value.length:e.limit-k.value.length>0?1:0)),C=(e,s,a=!1)=>{h(e).then((s=>{s?E(e):P(e,"上传失败")})).catch((s=>{P(e,s)})).finally((()=>{a||I(s+1)}))},I=(s,a=!1)=>{const{autoUpload:o,beforeUpload:l}=e,t=o&&!a;if(s>=k.value.length)return void(e.autoRemoveFaildFile&&S());const r=k.value[s];if(100===r.progress)return r.status="done",r.uploadTask=void 0,void(t&&I(s+1));if(!l)return void C(r,s,a);const i=l(r.file);[n(i),M(i)].includes(!0)||H("[TnImageUpload]","beforeUpload返回值必须是Promise或者Boolean"),n(i)?i.then((e=>{e?C(r,s,a):(B(s),t&&I(s))})).catch((e=>{r.status="failed"})):i?C(r,s,a):(B(s),t&&I(s))},_=()=>{F=!0;const a=k.value.filter((e=>"done"===e.status)).map((e=>e.url));s(N,a),v((()=>{var o;s(O,a),e.validateEvent&&(null==(o=null==U?void 0:U.validate)||o.call(U,"change").catch((e=>{})))}))},E=e=>{e.status="done",e.progress=100,e.uploadTask=void 0,e.file=void 0,s("success",e),_()},P=(e,a)=>{e.status="failed",e.progress=0,e.uploadTask=void 0,e.file=void 0,T(a),s("fail",new Error(a),e)},S=()=>{[...k.value].forEach(((e,s)=>{"failed"===e.status&&B(s)}))},B=e=>{const a=k.value[e];"uploading"===a.status&&a.uploadTask&&a.progress>0&&a.progress<100&&a.uploadTask.abort(),k.value.splice(e,1),"done"===a.status&&(s("remove",a.url),_())};return{fileList:k,isExceedMaxCount:w,chooseFile:async()=>{const{disabled:a,action:o,customUploadHandler:l}=e;if(a)return;if(!o&&!l)return void T("请设置action或者自定义图片上传处理函数");const t=k.value.length;y(x.value).then((a=>{let o=a;const l=b(o);l.length&&(T("文件格式或大小不符合要求"),s("oversizeOrNoSupport",l),o=o.filter((e=>!l.includes(e)))),k.value.push(...o.map((e=>({url:e.path,status:"ready",progress:0,file:e})))),e.autoUpload&&o.length&&I(t)})).catch((e=>{T((null==e?void 0:e.errMsg)||"选择图片失败")}))},retryUploadFile:e=>{const s=k.value[e];s.status="ready",s.progress=0,I(e,!0)},retryAllUpload:()=>{const e=k.value.findIndex((e=>"failed"===e.status));I(e)},customUploadHandle:()=>{k.value.length&&I(0)},removeFileEvent:s=>{const{disabled:a,beforeRemove:o}=e;if(a)return;const l=k.value[s];l&&m({title:"操作提示",content:"确认需要移除该图片吗?",showCancel:!0,cancelText:"取 消",confirmText:"确 认",success:e=>{if(e.confirm){if(!o)return void B(s);const e=o(l);[n(e),M(e)].includes(!0)||H("[TnImageUpload]","beforeRemove返回值必须是Promise或者Boolean"),n(e)?e.then((e=>{e&&B(s)})).catch((e=>{})):e&&B(s)}}})},clearAllFile:()=>{k.value.forEach((e=>{"uploading"===e.status&&e.uploadTask&&e.progress>0&&e.progress<100&&e.uploadTask.abort()})),k.value=[],_()},previewImage:e=>{const a=k.value.filter((e=>"done"===e.status)).map((e=>e.url));f({current:e,urls:a}),s("preview",a[e])}}},K=z(y({__name:"image-upload",props:D,emits:{[N]:e=>a(e),[O]:e=>a(e),oversizeOrNoSupport:e=>!0,success:e=>!0,fail:(e,s)=>!0,remove:e=>!0,preview:e=>!0},setup(e,{expose:s}){const a=e,o=h("image-upload"),l=h("image-upload-item"),{fileList:t,isExceedMaxCount:r,chooseFile:i,retryUploadFile:n,retryAllUpload:u,customUploadHandle:d,removeFileEvent:c,clearAllFile:p,previewImage:m}=J(a);return s({chooseFile:i,upload:d,retry:u,clear:p}),(e,s)=>{const a=A,u=B;return b(),T(u,{class:E([x(o).b()])},{default:U((()=>[k(" 上传列表 "),(b(!0),F(C,null,w(x(t),((s,o)=>(b(),T(u,{key:o,class:E([x(l).b(),x(l).is("custom",!!e.$slots.uploadImage)])},{default:U((()=>[I(e.$slots,"uploadImage",{data:s},(()=>[k(" 已上传图片 "),_(u,{class:E(["tn-gray-light_bg",[x(l).e("image"),x(l).is("finish","done"===s.status)]]),onClick:S((e=>x(m)(o)),["stop"])},{default:U((()=>[_(a,{class:"image",src:s.url,mode:"aspectFill"},null,8,["src"])])),_:2},1032,["class","onClick"]),k(" 删除按钮 "),e.showRemove&&!e.disabled?(b(),T(u,{key:0,class:E([x(l).e("remove")]),onClick:S((e=>x(c)(o)),["stop"])},{default:U((()=>[_(u,{class:E([x(l).em("remove","icon")])},{default:U((()=>[_(P,{name:"close-fill"})])),_:1},8,["class"])])),_:2},1032,["class","onClick"])):k("v-if",!0),k(" 重试蒙层 "),"failed"!==s.status||e.disabled?k("v-if",!0):(b(),T(u,{key:1,class:E([x(l).e("retry")]),onClick:S((e=>x(n)(o)),["stop"])},{default:U((()=>[_(P,{name:"refresh-simple"})])),_:2},1032,["class","onClick"])),k(" 进度波浪 "),k(" 进度0 ~ 100 => -300 ~ -400 "),e.showUploadProgress&&s.progress>0&&s.progress<100&&!e.disabled?(b(),T(u,{key:2,class:E([x(l).e("progress"),x(l).is("finish",100===s.progress)])},{default:U((()=>[_(u,{class:E([x(l).em("progress","wave")]),style:j({top:-300-s.progress+"%"})},null,8,["class","style"]),_(u,{class:E([x(l).em("progress","wave")]),style:j({top:-300-s.progress+"%"})},null,8,["class","style"])])),_:2},1032,["class"])):k("v-if",!0)]),!0)])),_:2},1032,["class"])))),128)),k(" 上传按钮 "),x(r)||e.disabled?k("v-if",!0):I(e.$slots,"uploadBtn",{key:0},(()=>[_(u,{class:E(["tn-gray-light_bg tn-gray-disabled_text",[x(l).b()]]),onClick:S(x(i),["stop"])},{default:U((()=>[_(u,{class:E([x(l).e("add-btn")])},{default:U((()=>[I(e.$slots,"addBtn",{},(()=>[_(u,{class:E([x(l).em("add-btn","icon")])},{default:U((()=>[_(P,{name:"add-fill"})])),_:1},8,["class"])]),!0)])),_:3},8,["class"])])),_:3},8,["class","onClick"])]),!0)])),_:3},8,["class"])}}}),[["__scopeId","data-v-33ebad38"]]);export{K as T,V as i};

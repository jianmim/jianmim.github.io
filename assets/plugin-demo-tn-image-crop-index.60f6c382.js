import{b as e,V as a,W as t,X as r,c as o,z as n,r as s,y as l,N as i,H as c,a5 as h,L as d,ax as u,aX as p,aY as g,aV as m,aZ as v,a as x,o as y,i as w,h as f,f as I,K as M,u as P,C as b,g as C,n as T,F as _,p as H,k as R,ay as S,_ as z,D as j,E as $,m as E,e as k,aR as X}from"./index-80b03063.js";import{T as Y}from"./avatar.714c39a9.js";import{T as q}from"./popup.cb51da11.js";import{d as F}from"./index.b621671f.js";import{u as B}from"./index.38361e72.js";import{C as N}from"./custom-page.333ee63a.js";import{D as V}from"./demo-container.59d4003d.js";import{u as L}from"./index.e83e3f39.js";import"./badge.9856adf0.js";import"./is-number.acae358a.js";import"./overlay.66eb0f69.js";import"./event.5568c9d8.js";import"./install.171bae2e.js";import"./title.e0fd12f0.js";const W=e({src:{type:String,required:!0},circle:{type:Boolean,default:!1},borderColor:{type:String,default:"#fff"},bgColor:{type:String,default:"rgba(0, 0, 0, 0.5)"},zIndex:{type:Number,default:100},minScale:{type:Number,default:.5},maxScale:{type:Number,default:2}}),D={base64:!1,cropRatio:1,quality:1},K=e=>{const a=l(),t=`ticgc-${i()}`;let r;const x=n({width:0,height:0}),{cropContainerId:y,cropRect:w,previewImageRect:f,operationImageWidth:I,operationImageHeight:M,loadImageErrorHandle:P,loadImageFinishHandle:b,imageTouchStartHandle:C,imageTouchMoveHandle:T,imageTouchEndHandle:_}=(e=>{const a=l(),t=`ticc-${i()}`,{getSelectorNodeInfo:r}=B(a),o=n({width:0,height:0,left:0,top:0}),h=n({width:0,height:0,left:0,top:0,centerPoint:{x:0,y:0},translate:{x:0,y:0},scale:1,angle:0});let d=0;const u=s(0),p=s(0),g=()=>{const{width:e,height:a}=o;e&&a?(d>1?(h.height=o.height,h.width=o.height*d,h.left=o.left-(h.width-o.width)/2,h.top=o.top):(h.width=o.width,h.height=o.width/d,h.left=o.left,h.top=o.top-(h.height-o.height)/2),I()):setTimeout((()=>{g()}),150)};let m=!1;const v=[{x:0,y:0},{x:0,y:0}],x={x:0,y:0};let y=0;const w={x:0,y:0},f={x:0,y:0},I=()=>{const{width:e,height:a,translate:t}=h;h.centerPoint.x=e/2-t.x,h.centerPoint.y=a/2-t.y},M=(e,a)=>({x:Math.round(e.x-a.x),y:Math.round(e.y-a.y)}),P=e=>Math.sqrt(Math.pow(e.x,2)+Math.pow(e.y,2)),b=(e,a)=>{const t=e.x*a.y-a.x*e.y>0?1:-1,r=P(e)*P(a);if(0===r)return 0;let o=(e.x*a.x+e.y*a.y)/r;return o>1&&(o=1),o<-1&&(o=-1),Math.acos(o)*t*180/Math.PI},C=(e,a)=>{const{x:t,y:r}=e,o=Math.abs(t),n=Math.abs(r),s=Math.sqrt(t*t+r*r);let l=0;t>0&&r>=0?l=Math.atan(n/o):t<=0&&r>0?l=Math.atan(o/n)+Math.PI/2:t<0&&r<=0?l=Math.atan(n/o)+Math.PI:t>=0&&r<0&&(l=Math.atan(o/n)+3*Math.PI/2);const i=T(l+a*Math.PI/180);return _(s,i)},T=e=>{let a=e;for(;a<0;)a+=2*Math.PI;for(;a>=2*Math.PI;)a-=2*Math.PI;return a},_=(e,a)=>{const t=Math.PI,r=t/2;let o=0,n=0;return a>=0&&a<r?(o=Math.cos(a)*e,n=Math.sin(a)*e):a>=r&&a<t?(a-=r,o=-Math.sin(a)*e,n=Math.cos(a)*e):a>=t&&a<3*r?(a-=t,o=-Math.cos(a)*e,n=-Math.sin(a)*e):a>=3*r&&a<2*t&&(a-=3*r,o=Math.sin(a)*e,n=-Math.cos(a)*e),{x:o,y:n}};let H=0;const R=async()=>{try{const e=await r(`#${t}`);o.width=e.width||0,o.height=e.height||0,o.left=e.left||0,o.top=e.top||0}catch(e){if(H>10)return void(H=0);setTimeout((()=>{R(),H++}),250)}};return{cropContainerId:t,cropRect:o,previewImageRect:h,operationImageWidth:u,operationImageHeight:p,getContainerRectInfo:R,loadImageErrorHandle:e=>{e.detail.errMsg},loadImageFinishHandle:e=>{const{width:a=0,height:t=0}=e.detail;u.value=a,p.value=t,d=a/t,o.width&&o.height?c((()=>{g()})):c((()=>{setTimeout((()=>{R().then((()=>{g()}))}),300)}))},imageTouchStartHandle:e=>{const a=e.touches||e.changedTouches;m=!0,1===a.length?(v[0].x=a[0].pageX,v[0].y=a[0].pageY,x.x=h.translate.x,x.y=h.translate.y):(v[0].x=a[0].pageX,v[0].y=a[0].pageY,v[1].x=a[1].pageX,v[1].y=a[1].pageY,y=Math.sqrt(Math.pow(v[0].x-v[1].x,2)+Math.pow(v[0].y-v[1].y,2)),w.x=a[0].pageX,w.y=a[0].pageY,f.x=a[1].pageX,f.y=a[1].pageY)},imageTouchMoveHandle:a=>{if(!m)return;const t=a.touches||a.changedTouches;if(1===t.length){const e=t[0].pageX-v[0].x,a=t[0].pageY-v[0].y,{x:r,y:o}=C({x:e,y:a},-h.angle);h.translate.x=x.x+r,h.translate.y=x.y+o}else{const a=Math.sqrt(Math.pow(t[0].pageX-t[1].pageX,2)+Math.pow(t[0].pageY-t[1].pageY,2));let r=h.scale*(a/y);r<e.minScale.value&&(r=e.minScale.value),r>e.maxScale.value&&(r=e.maxScale.value),h.scale=r,y=a;const o={x:t[1].pageX,y:t[1].pageY},n=M(f,w),s=M(o,w),l=b(n,s);f.x=o.x,f.y=o.y,h.angle+=l}I()},imageTouchEndHandle:()=>{m&&(m=!1)}}})(h(e)),H=o((()=>f.width/I.value)),R=o((()=>f.height/M.value)),S=async(o,n)=>{~o.indexOf("https:")&&(o=await z(o));const s=n.cropRatio||1;return new Promise(((l,i)=>{try{const c=-(f.centerPoint.x-w.width/2)/H.value,h=-(f.centerPoint.y-w.height/2)/R.value,d={x:x.width/2,y:x.height/2};null==r||r.translate(d.x,d.y),null==r||r.rotate(f.angle*Math.PI/180),null==r||r.scale(f.scale,f.scale),null==r||r.translate(-d.x,-d.y),e.circle&&(null==r||r.beginPath(),null==r||r.arc(x.width/2,x.height/2,x.width/2,0,2*Math.PI),null==r||r.clip()),null==r||r.drawImage(o,c*s,h*s,I.value*s,M.value*s),null==r||r.draw(!1,(()=>{const e={width:x.width,height:x.height,destWidth:x.width,destHeight:x.height,fileType:"png",quality:n.quality};n.base64?p({canvasId:t,x:0,y:0,width:e.width,height:e.height,success:e=>{const a=new Uint8Array(e.data),t=g(a);l(t)},fail:e=>{F("[TnImageCrop]",e),i(e)}},a):m({canvasId:t,...e,success:e=>{l(e.tempFilePath)},fail:e=>{F("[TnImageCrop]",e),i(e)}},a)}))}catch(c){i(c)}}))},z=e=>new Promise(((a,t)=>{v({url:e,success:e=>{a(e.tempFilePath)},fail:e=>{t(e)}})}));return d((()=>{r||(r=u(t,a))})),{cropContainerId:y,generateCanvasId:t,previewImageRect:f,canvasRectInfo:x,loadImageErrorHandle:P,loadImageFinishHandle:b,imageTouchStartHandle:C,imageTouchMoveHandle:T,imageTouchEndHandle:_,saveImage:a=>{if(!e.src)return Promise.reject("图片地址不能为空");a={...D,...a};const t=I.value/M.value,r=w.width/w.height;return r>t?(x.width=I.value*(a.cropRatio||1),x.height=I.value*(a.cropRatio||1)/r):(x.width=M.value*(a.cropRatio||1)*r,x.height=M.value*(a.cropRatio||1)),S(e.src,a)}}},O=z(x({__name:"index",props:W,setup(e,{expose:n}){const s=e,{generateCanvasId:l,cropContainerId:i,previewImageRect:c,canvasRectInfo:h,loadImageErrorHandle:d,loadImageFinishHandle:u,imageTouchStartHandle:p,imageTouchMoveHandle:g,imageTouchEndHandle:m,saveImage:v}=K(s),{ns:x,imageCropStyle:z,cropPreviewClass:j,cropPreviewStyle:$,cropPreviewBorderClass:E,cropPreviewBorderStyle:k,previewImageStyle:X}=(e=>{const n=a("image-crop"),[s,l]=t(r(e,"bgColor"),"border"),[i,c]=t(r(e,"borderColor"),"border"),h=o((()=>{const a={};return e.zIndex&&(a.zIndex=e.zIndex),a})),d=o((()=>{const e=[n.e("crop-preview")];return s.value&&e.push(s.value),e.join(" ")})),u=o((()=>{const a={};return l.value&&(a.borderColor=l.value),e.zIndex&&(a.zIndex=e.zIndex),e.circle&&(a.borderRadius="50%"),a})),p=o((()=>{const e=[n.em("crop-preview","border")];return i.value&&e.push(i.value),e.join(" ")})),g=o((()=>{const a={};return c.value&&(a.borderColor=c.value),e.zIndex&&(a.zIndex=e.zIndex+1),e.circle&&(a.borderRadius="50%"),a})),m=o((()=>{const a={};return e.zIndex&&(a.zIndex=e.zIndex-1),a}));return{ns:n,imageCropStyle:h,cropPreviewClass:d,cropPreviewStyle:u,cropPreviewBorderClass:p,cropPreviewBorderStyle:g,previewImageStyle:m}})(s);return n({save:v}),(e,a)=>{const t=H,r=R,o=S;return y(),w(_,null,[f(r,{class:M([P(x).b()]),style:b(P(z))},{default:I((()=>{var a,o,n,s;return[f(r,{class:M([P(x).e("image-preview")]),style:b({...P(X),width:(null==(a=P(c))?void 0:a.width)?`${P(c).width}px`:"auto",height:(null==(o=P(c))?void 0:o.height)?`${P(c).height}px`:"auto",left:(null==(n=P(c))?void 0:n.left)?`${P(c).left}px`:"0",top:(null==(s=P(c))?void 0:s.top)?`${P(c).top}px`:"0",transformOrigin:`${P(c).centerPoint.x}px ${P(c).centerPoint.y}px`,transform:`translate3d(${P(c).translate.x}px, ${P(c).translate.y}px, 0px) rotate(${P(c).angle}deg) scale(${P(c).scale})`})},{default:I((()=>[C(" 显示测试居中点 "),C(" <view\n        :style=\"{\n          position: 'absolute',\n          zIndex: 1000,\n          width: '10px',\n          height: '10px',\n          borderRadius: '50%',\n          left: `${previewImageRect.centerPoint.x}px`,\n          top: `${previewImageRect.centerPoint.y}px`,\n          transform: 'translate(-50%, -50%)',\n          backgroundColor: 'blue',\n        }\"\n      /> "),C(" 图片预览 "),f(t,{class:"tn-image",src:e.src,onError:P(d),onLoad:P(u)},null,8,["src","onError","onLoad"])])),_:1},8,["class","style"]),C(" 预览框 "),f(r,{class:M([P(j)]),style:b(P($))},{default:I((()=>[f(r,{id:P(i),class:M([P(x).em("crop-preview","container")])},{default:I((()=>[f(r,{class:M([P(E)]),style:b(P(k)),onTouchstart:T(P(p),["stop","prevent"]),onTouchmove:T(P(g),["stop","prevent"]),onTouchend:T(P(m),["stop","prevent"])},null,8,["class","style","onTouchstart","onTouchmove","onTouchend"])])),_:1},8,["id","class"])])),_:1},8,["class","style"])]})),_:1},8,["class","style"]),C(" 生成图片canvas容器 "),f(o,{id:P(l),"canvas-id":P(l),class:M([P(x).e("generate-canvas")]),style:b({width:`${P(h).width}px`,height:`${P(h).height}px`})},null,8,["id","canvas-id","class","style"])],64)}}}),[["__scopeId","data-v-45d909b5"]]),U=z(x({__name:"index",setup(e){j((()=>({}))),$((()=>({})));const{isDemoH5Page:a}=L(),t=s(),r=s(!1),o=s(""),n=s(""),l=()=>{X({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:e=>{0!==e.tempFilePaths.length&&(n.value=e.tempFilePaths[0],r.value=!0)}})},i=()=>{r.value=!1},c=async()=>{var e;try{const a=await(null==(e=t.value)?void 0:e.save());if(!a)return;o.value=a,i()}catch(a){await c()}};return(e,s)=>{const h=R;return y(),w(_,null,[f(N,{title:"图片裁剪","is-h5-demo-page":P(a)},{default:I((()=>[f(V,{title:"基础使用"},{default:I((()=>[f(h,{class:"tn-image-crop-container"},{default:I((()=>[f(h,{class:"tn-image-crop-item",onClick:T(l,["stop"])},{default:I((()=>[f(h,{class:"avatar"},{default:I((()=>[f(Y,{url:o.value,size:"xl"},null,8,["url"])])),_:1}),f(h,{class:"tips"},{default:I((()=>[E(" 点击修改头像 ")])),_:1})])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1},8,["is-h5-demo-page"]),f(q,{modelValue:r.value,"onUpdate:modelValue":s[0]||(s[0]=e=>r.value=e),width:"100vw",height:"100vh","z-index":3e4,"overlay-closeable":!1},{default:I((()=>[f(h,{class:"avatar-crop-container"},{default:I((()=>[f(h,{class:"avatar-crop-wrapper"},{default:I((()=>[r.value?(y(),k(O,{key:0,ref_key:"imageCropRef",ref:t,src:n.value,"z-index":3e4,circle:""},null,8,["src"])):C("v-if",!0)])),_:1}),f(h,{class:"avatar-crop-operation-bar"},{default:I((()=>[f(h,{class:"cancel-btn",onClick:T(i,["stop"])},{default:I((()=>[E(" 取消 ")])),_:1},8,["onClick"]),f(h,{class:"confirm-btn",onClick:T(c,["stop"])},{default:I((()=>[E("确认")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1},8,["modelValue"])],64)}}}),[["__scopeId","data-v-46296aec"]]);export{U as default};

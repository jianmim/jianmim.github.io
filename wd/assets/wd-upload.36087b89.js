import{L as e,d as s,r as a,q as o,v as t,h as i,j as l,o as n,c as u,w as r,e as c,F as d,f,n as m,a as p,b as v,t as y,p as _,u as h,x as w,y as b,l as g,i as k,g as C,X as F,z as T,H as z,ac as x}from"./index-dce73128.js";import{g as L,K as P,i as D,l as j,m as E,o as I,c as S,P as U,W as A,C as K,Q as M,t as N,b as R}from"./page-wraper.5690414d.js";import{u as H}from"./useTranslate.0a311b40.js";const O=R(s({name:"wd-upload",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"},props:{...L,fileList:P(),action:D(""),header:{type:Object,default:()=>{}},multiple:j(!1),disabled:j(!1),limit:E(0),showLimitNum:j(!0),maxSize:E(Number.MAX_VALUE),sourceType:{type:Array,default:()=>["album","camera"]},sizeType:{type:Array,default:()=>["original","compressed"]},name:D("file"),formData:{type:Object,default:()=>{}},onPreviewFail:Function,beforeUpload:Function,beforeChoose:Function,beforeRemove:Function,beforePreview:Function,buildFormData:Function,loadingType:D("ring"),loadingColor:D("#ffffff"),accept:D("image"),statusKey:D("status"),useDefaultSlot:j(!1),loadingSize:D("24px"),customEvokeClass:D(""),customPreviewClass:D(""),imageMode:D("aspectFit")},emits:["fail","change","success","progress","oversize","chooseerror","remove"],setup(s,{emit:L}){const P=s,{translate:D}=H("upload"),j=a([]),E=o((()=>!P.limit||j.value.length<P.limit));function R(e,s,a){const{statusKey:o}=P,t=j.value.findIndex((e=>e.uid===s.uid));t>-1&&(j.value[t][o]="fail",j.value[t].error=e.message,j.value[t].response=e,L("fail",{error:e,file:s,formData:a}))}function O(e,s){const{action:a,name:o,header:t={},accept:i}=P;x({url:a,header:t,name:o,fileName:o,fileType:i,formData:s,filePath:e.url,success(a){200===a.statusCode?function(e,s,a){const{statusKey:o}=P,t=j.value.findIndex((e=>e.uid===s.uid));t>-1&&(j.value[t][o]="success",j.value[t].response=e.data,L("change",{fileList:j.value}),L("success",{file:s,fileList:j.value,formData:a}))}(a,e,s):R(a,e,s)},fail(a){R(a,e,s)}}).onProgressUpdate((s=>{!function(e,s){const a=j.value.findIndex((e=>e.uid===s.uid));a>-1&&(j.value[a].percent=e.progress,L("progress",{response:e,file:s}))}(s,e)}))}function X(){const{multiple:s,maxSize:a,accept:o,sizeType:t,limit:i,sourceType:l,beforeUpload:n}=P;"image"===o&&function({multiple:s,sizeType:a,sourceType:o,maxCount:t}){return new Promise(((i,l)=>{e({count:s?Math.min(t,9):1,sizeType:a,sourceType:o,success:i,fail:l})}))}({multiple:s,sizeType:t,sourceType:l,maxCount:i?i-j.value.length:9}).then((e=>{let o=Array.prototype.slice.call(e.tempFiles);s||(o=o.slice(0,1));const t=e=>{e.forEach((async e=>{var s;N(e.size)||(e.size=await(s=e.path,new Promise(((e,a)=>{z({src:s,success:s=>{e(s.height*s.width)},fail:()=>{a(0)}})})))),e.size<=a?function(e){const s={uid:A.id++,name:e.name||"",status:"loading",size:e.size,url:e.path,action:P.action,percent:0};j.value.push(s);const{buildFormData:a,formData:o={}}=P;a?a({file:s,formData:o,resolve:e=>{e&&O(s,e)}}):O(s,o)}(e):L("oversize",{file:e})}))};n?n({files:o,fileList:j.value,resolve:e=>{e&&t(o)}}):t(o)})).catch((e=>{L("chooseerror",{error:e})}))}function $(){if(P.disabled)return;const{beforeChoose:e}=P;e?e({fileList:j.value,resolve:e=>{e&&X()}}):X()}function q(e,s){j.value.splice(j.value.findIndex((s=>s.uid===e.uid)),1),L("change",{fileList:j.value}),L("remove",{file:e})}function G(e,s){const{onPreviewFail:a}=P;F({urls:s,current:s[e],fail(){a?a({index:e,imgList:s}):T({title:"预览图片失败",icon:"none"})}})}return t((()=>P.fileList),(e=>{const{statusKey:s}=P;if(U(e,j.value))return;const a=e.map((e=>(e.uid=A.id++,e[s]=e[s]||"success",e.action=P.action||"",e.response=e.response||"",e)));j.value=a}),{deep:!0,immediate:!0}),t((()=>P.limit),(e=>{e&&e<j.value.length&&console.error("[wot-design]Error: props limit must less than fileList.length")}),{deep:!0,immediate:!0}),t((()=>P.beforePreview),(e=>{e&&!K(e)&&"asyncfunction"!==M(e)&&console.error("The type of beforePreview must be Function")}),{deep:!0,immediate:!0}),t((()=>P.onPreviewFail),(e=>{e&&!K(e)&&"asyncfunction"!==M(e)&&console.error("The type of onPreviewFail must be Function")}),{deep:!0,immediate:!0}),t((()=>P.beforeRemove),(e=>{e&&!K(e)&&"asyncfunction"!==M(e)&&console.error("The type of beforeRemove must be Function")}),{deep:!0,immediate:!0}),t((()=>P.beforeUpload),(e=>{e&&!K(e)&&"asyncfunction"!==M(e)&&console.error("The type of beforeUpload must be Function")}),{deep:!0,immediate:!0}),t((()=>P.beforeChoose),(e=>{e&&!K(e)&&"asyncfunction"!==M(e)&&console.error("The type of beforeChoose must be Function")}),{deep:!0,immediate:!0}),t((()=>P.buildFormData),(e=>{e&&!K(e)&&"asyncfunction"!==M(e)&&console.error("The type of buildFormData must be Function")}),{deep:!0,immediate:!0}),(e,s)=>{const a=g,o=k,t=i(l("wd-loading"),I),F=C,T=i(l("wd-icon"),S);return n(),u(o,{class:m(["wd-upload",e.customClass]),style:b(e.customStyle)},{default:r((()=>[(n(!0),c(d,null,f(j.value,((s,i)=>(n(),u(o,{class:m(["wd-upload__preview",e.customPreviewClass]),key:i},{default:r((()=>[p(o,{class:"wd-upload__status-content"},{default:r((()=>[p(a,{src:s.url,mode:e.imageMode,class:"wd-upload__picture",onClick:e=>function(e){const{beforePreview:s}=P,a=j.value.map((e=>e.url));s?s({index:e,imgList:a,resolve:s=>{s&&G(e,a)}}):G(e,a)}(i)},null,8,["src","mode","onClick"])])),_:2},1024),"success"!==s.status?(n(),u(o,{key:0,class:"wd-upload__mask wd-upload__status-content"},{default:r((()=>["loading"===s.status?(n(),u(o,{key:0,class:"wd-upload__status-content"},{default:r((()=>[p(t,{type:e.loadingType,size:e.loadingSize,color:e.loadingColor},null,8,["type","size","color"]),p(F,{class:"wd-upload__progress-txt"},{default:r((()=>[v(y(s.percent)+"%",1)])),_:2},1024)])),_:2},1024)):_("",!0),"fail"===s.status?(n(),u(o,{key:1,class:"wd-upload__status-content"},{default:r((()=>[p(T,{name:"close-outline","custom-class":"wd-upload__icon"}),p(F,{class:"wd-upload__progress-txt"},{default:r((()=>[v(y(s.error||h(D)("error")),1)])),_:2},1024)])),_:2},1024)):_("",!0)])),_:2},1024)):_("",!0),"loading"===s.status||e.disabled?_("",!0):(n(),u(T,{key:1,name:"error-fill","custom-class":"wd-upload__close",onClick:e=>function(e){const{beforeRemove:s}=P,a=e,o=j.value[a];s?s({file:o,index:a,fileList:j.value,resolve:e=>{e&&q(o)}}):q(o)}(i)},null,8,["onClick"]))])),_:2},1032,["class"])))),128)),h(E)?(n(),c(d,{key:0},[e.$slots.default?(n(),u(o,{key:0,class:m(["wd-upload__evoke-slot",e.customEvokeClass]),onClick:$},{default:r((()=>[w(e.$slots,"default",{},void 0,!0)])),_:3},8,["class"])):(n(),u(o,{key:1,onClick:$,class:m(["wd-upload__evoke",e.disabled?"is-disabled":"",e.customEvokeClass])},{default:r((()=>[p(T,{class:"wd-upload__evoke-icon",name:"fill-camera"}),e.limit&&e.showLimitNum?(n(),u(o,{key:0,class:"wd-upload__evoke-num"},{default:r((()=>[v("（"+y(j.value.length)+"/"+y(e.limit)+"）",1)])),_:1})):_("",!0)])),_:1},8,["class"]))],64)):_("",!0)])),_:3},8,["class","style"])}}}),[["__scopeId","data-v-0d3dc5d6"]]);export{O as _};
